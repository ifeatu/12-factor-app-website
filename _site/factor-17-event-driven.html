<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factor 17: Event-Driven | The Modern 17-Factor App</title>
    <meta name="description" content="Asynchronous communication and event sourcing">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/12-factor-app-website/assets/css/main.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SEO -->
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Factor 17: Event-Driven | The Modern 17-Factor App</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Factor 17: Event-Driven" />
<meta name="author" content="Pierre Brunelle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Asynchronous communication and event sourcing" />
<meta property="og:description" content="Asynchronous communication and event sourcing" />
<link rel="canonical" href="http://localhost:4000/12-factor-app-website/factor-17-event-driven.html" />
<meta property="og:url" content="http://localhost:4000/12-factor-app-website/factor-17-event-driven.html" />
<meta property="og:site_name" content="The Modern 17-Factor App" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Factor 17: Event-Driven" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Pierre Brunelle"},"description":"Asynchronous communication and event sourcing","headline":"Factor 17: Event-Driven","url":"http://localhost:4000/12-factor-app-website/factor-17-event-driven.html"}</script>
<!-- End Jekyll SEO tag -->

    
    <!-- Feed -->
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/12-factor-app-website/feed.xml" title="The Modern 17-Factor App" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/12-factor-app-website/" class="brand-link">
                    <i class="fas fa-cube brand-icon"></i>
                    <span class="brand-text">The Modern 17-Factor App</span>
                </a>
            </div>
            
            <div class="nav-menu" id="nav-menu">
                <a href="/12-factor-app-website/" class="nav-link ">
                    <i class="fas fa-home"></i> Home
                </a>
                <div class="nav-dropdown">
                    <a href="#" class="nav-link dropdown-toggle">
                        <i class="fas fa-list"></i> Factors <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-content">
                        <div class="dropdown-section">
                            <h4>Original 12 Factors</h4>
                            <a href="/12-factor-app-website/factor-01-codebase">1. Codebase</a>
                            <a href="/12-factor-app-website/factor-02-dependencies">2. Dependencies</a>
                            <a href="/12-factor-app-website/factor-03-config">3. Config</a>
                            <a href="/12-factor-app-website/factor-04-backing-services">4. Backing Services</a>
                            <a href="/12-factor-app-website/factor-05-build-release-run">5. Build, Release, Run</a>
                            <a href="/12-factor-app-website/factor-06-processes">6. Processes</a>
                            <a href="/12-factor-app-website/factor-07-port-binding">7. Port Binding</a>
                            <a href="/12-factor-app-website/factor-08-concurrency">8. Concurrency</a>
                            <a href="/12-factor-app-website/factor-09-disposability">9. Disposability</a>
                            <a href="/12-factor-app-website/factor-10-dev-prod-parity">10. Dev/Prod Parity</a>
                            <a href="/12-factor-app-website/factor-11-logs">11. Logs</a>
                            <a href="/12-factor-app-website/factor-12-admin-processes">12. Admin Processes</a>
                        </div>
                        <div class="dropdown-section">
                            <h4>New 5 Factors</h4>
                            <a href="/12-factor-app-website/factor-13-api-first">13. API First</a>
                            <a href="/12-factor-app-website/factor-14-graphql-grpc">14. GraphQL & gRPC</a>
                            <a href="/12-factor-app-website/factor-15-auth">15. Authentication & Authorization</a>
                            <a href="/12-factor-app-website/factor-16-event-driven">16. Event-Driven Architecture</a>
                            <a href="/12-factor-app-website/factor-17-failure-isolation">17. Failure Isolation</a>
                        </div>
                    </div>
                </div>
                <a href="https://github.com/ifeatu/12-factor-app-website" target="_blank" class="nav-link">
                    <i class="fab fa-github"></i> GitHub
                </a>
            </div>
            
            <div class="nav-toggle" id="nav-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="factor-page">
    <!-- Factor Header -->
    <div class="factor-header">
        <div class="container">
            <div class="factor-nav">
                <a href="/12-factor-app-website/" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Overview
                </a>
                
                <div class="factor-navigation">
                    
                        <a href="/12-factor-app-website/factor-16-auth" class="nav-btn prev-btn">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    
                    
                    
                        <a href="/12-factor-app-website/factor-18-failure-isolation" class="nav-btn next-btn">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    
                </div>
            </div>
            
            <div class="factor-title">
                
                
                    <div class="factor-number-circle"></div>
                    <h1 class="factor-name">Event-Driven</h1>
                
                
                
                    <p class="factor-description">Asynchronous communication and event sourcing</p>
                
            </div>
        </div>
    </div>

    <!-- Factor Content -->
    <div class="factor-content">
        <div class="container">
            <div class="content-wrapper">
                <!-- Table of Contents -->
                <aside class="toc-sidebar">
                    <div class="toc-container">
                        <h3>Table of Contents</h3>
                        <div id="toc"></div>
                    </div>
                </aside>
                
                <!-- Main Content -->
                <article class="factor-article">
                    <h1 id="factor-17-event-driven">Factor 17: Event-Driven</h1>

<h2 id="asynchronous-communication-and-event-sourcing">Asynchronous communication and event sourcing</h2>

<h3 id="modern-principle">Modern Principle</h3>

<p>Synchronous request-response patterns create tight coupling and scaling bottlenecks. Modern applications increasingly adopt event-driven architectures for loose coupling, horizontal scalability, and real-time processing. Events become the primary integration mechanism between services.</p>

<h4 id="event-streaming-with-kafka">Event Streaming with Kafka</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Event producer
</span><span class="kn">from</span> <span class="nn">confluent_kafka</span> <span class="kn">import</span> <span class="n">Producer</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">EventProducer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">Producer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">topic_registry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'OrderCreated'</span><span class="p">:</span> <span class="s">'orders.events'</span><span class="p">,</span>
            <span class="s">'PaymentProcessed'</span><span class="p">:</span> <span class="s">'payments.events'</span><span class="p">,</span>
            <span class="s">'InventoryUpdated'</span><span class="p">:</span> <span class="s">'inventory.events'</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">publish_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'event_id'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="s">'event_type'</span><span class="p">:</span> <span class="n">event</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">().</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s">'source'</span><span class="p">:</span> <span class="s">'order-service'</span><span class="p">,</span>
            <span class="s">'correlation_id'</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">'correlation_id'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="p">}</span>
        
        <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">topic_registry</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">event</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="s">'domain.events'</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">producer</span><span class="p">.</span><span class="n">produce</span><span class="p">(</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">aggregate_id</span><span class="p">),</span>
            <span class="n">value</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">event</span><span class="p">)),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="n">items</span><span class="p">()],</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_delivery_report</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">producer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_delivery_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">'Event delivery failed: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">'Event delivered to </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="n">topic</span><span class="p">()</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="n">partition</span><span class="p">()</span><span class="si">}</span><span class="s">]'</span><span class="p">)</span>

<span class="c1"># Event consumer with exactly-once semantics
</span><span class="kn">from</span> <span class="nn">confluent_kafka</span> <span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">KafkaError</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">EventConsumer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">topics</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">({</span>
            <span class="o">**</span><span class="n">config</span><span class="p">,</span>
            <span class="s">'enable.auto.commit'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">'isolation.level'</span><span class="p">:</span> <span class="s">'read_committed'</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">register_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
    
    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">error</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">code</span><span class="p">()</span> <span class="o">==</span> <span class="n">KafkaError</span><span class="p">.</span><span class="n">_PARTITION_EOF</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">'Consumer error: </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="n">error</span><span class="p">()</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Process event
</span>                <span class="n">event_type</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">headers</span><span class="p">()).</span><span class="n">get</span><span class="p">(</span><span class="s">'event_type'</span><span class="p">,</span> <span class="sa">b</span><span class="s">''</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
                
                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">handlers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                    <span class="n">handler</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
                
                <span class="c1"># Commit after successful processing
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">.</span><span class="n">commit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s">'Error processing event: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
                <span class="c1"># Implement retry logic or dead letter queue
</span></code></pre></div></div>

<h4 id="event-sourcing-pattern">Event Sourcing Pattern</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Event sourced aggregate
</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">aggregate_id</span> <span class="o">=</span> <span class="n">aggregate_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">OrderCreated</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customer_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>

<span class="k">class</span> <span class="nc">OrderShipped</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tracking_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="n">tracking_number</span>

<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'PENDING'</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">uncommitted_events</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Order already created"</span><span class="p">)</span>
        
        <span class="n">event</span> <span class="o">=</span> <span class="n">OrderCreated</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">uncommitted_events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">ship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracking_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">'PENDING'</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Cannot ship order in </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">status</span><span class="si">}</span><span class="s"> status"</span><span class="p">)</span>
        
        <span class="n">event</span> <span class="o">=</span> <span class="n">OrderShipped</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">tracking_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">uncommitted_events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_apply_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">OrderCreated</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">aggregate_id</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">customer_id</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">items</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'PENDING'</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">OrderShipped</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">tracking_number</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'SHIPPED'</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">]):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">order</span><span class="p">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span>

<span class="c1"># Event store
</span><span class="k">class</span> <span class="nc">EventStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_connection</span>
    
    <span class="k">def</span> <span class="nf">save_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">],</span> <span class="n">expected_version</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx</span><span class="p">:</span>
            <span class="c1"># Check for concurrent modifications
</span>            <span class="n">current_version</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s">"SELECT MAX(version) FROM events WHERE aggregate_id = ?"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">aggregate_id</span><span class="p">,)</span>
            <span class="p">).</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">expected_version</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConcurrencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s">"Expected version </span><span class="si">{</span><span class="n">expected_version</span><span class="si">}</span><span class="s">, but was </span><span class="si">{</span><span class="n">current_version</span><span class="si">}</span><span class="s">"</span>
                <span class="p">)</span>
            
            <span class="c1"># Save events
</span>            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="n">tx</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
                    INSERT INTO events (
                        aggregate_id, event_type, event_data,
                        version, timestamp
                    ) VALUES (?, ?, ?, ?, ?)
                """</span><span class="p">,</span> <span class="p">(</span>
                    <span class="n">aggregate_id</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
                    <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">event</span><span class="p">)),</span>
                    <span class="n">current_version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span>
                <span class="p">))</span>
                <span class="n">current_version</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
            SELECT event_type, event_data
            FROM events
            WHERE aggregate_id = ?
            ORDER BY version
        """</span><span class="p">,</span> <span class="p">(</span><span class="n">aggregate_id</span><span class="p">,)).</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">event_data</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
            <span class="c1"># Reconstruct event object
</span>            <span class="n">event_class</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">event_type</span><span class="p">]</span>
            <span class="n">events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_class</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">events</span>

    <span class="k">def</span> <span class="nf">replay_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="s">"""Replay events to rebuild aggregate state"""</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_events</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">order</span><span class="p">.</span><span class="n">_apply_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">order</span>

<span class="c1">#### CQRS Implementation
</span>
<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="c1"># Command and Query separation
</span><span class="k">class</span> <span class="nc">CommandHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span> <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventProducer</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span>
    
    <span class="k">def</span> <span class="nf">handle_create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">CreateOrderCommand</span><span class="p">):</span>
        <span class="c1"># Load aggregate
</span>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">()</span>
        
        <span class="c1"># Execute business logic
</span>        <span class="n">order</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="n">command</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">command</span><span class="p">.</span><span class="n">items</span>
        <span class="p">)</span>
        
        <span class="c1"># Save events
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">event_store</span><span class="p">.</span><span class="n">save_events</span><span class="p">(</span>
            <span class="n">order</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">order</span><span class="p">.</span><span class="n">uncommitted_events</span><span class="p">,</span>
            <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="c1"># Publish events
</span>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">order</span><span class="p">.</span><span class="n">uncommitted_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">event_bus</span><span class="p">.</span><span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">order</span><span class="p">.</span><span class="nb">id</span>

<span class="k">class</span> <span class="nc">QueryHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_model_db</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">read_model_db</span>
    
    <span class="k">def</span> <span class="nf">get_order_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
            SELECT * FROM order_projections
            WHERE order_id = ?
        """</span><span class="p">,</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,)).</span><span class="n">fetchone</span><span class="p">()</span>

<span class="c1"># Projection builder
</span><span class="k">class</span> <span class="nc">OrderProjectionBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_model_db</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">read_model_db</span>
    
    <span class="k">def</span> <span class="nf">handle_order_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderCreated</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
            INSERT INTO order_projections (
                order_id, customer_id, items, status, created_at
            ) VALUES (?, ?, ?, ?, ?)
        """</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">event</span><span class="p">.</span><span class="n">aggregate_id</span><span class="p">,</span>
            <span class="n">event</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">items</span><span class="p">),</span>
            <span class="s">'PENDING'</span><span class="p">,</span>
            <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span>
        <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">handle_order_shipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderShipped</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
            UPDATE order_projections
            SET status = 'SHIPPED',
                tracking_number = ?,
                shipped_at = ?
            WHERE order_id = ?
        """</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">event</span><span class="p">.</span><span class="n">tracking_number</span><span class="p">,</span>
            <span class="n">event</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">event</span><span class="p">.</span><span class="n">aggregate_id</span>
        <span class="p">))</span>
</code></pre></div></div>

<h3 id="best-practices">Best Practices</h3>

<ol>
  <li><strong>Idempotent event handlers</strong> - Handle duplicate events gracefully</li>
  <li><strong>Event versioning</strong> - Support schema evolution</li>
  <li><strong>Dead letter queues</strong> - Handle processing failures</li>
  <li><strong>Event ordering</strong> - Maintain causal consistency</li>
  <li><strong>Retention policies</strong> - Balance history vs storage</li>
</ol>

<h3 id="key-takeaways">Key Takeaways</h3>

<ol>
  <li>Events enable loose coupling between services</li>
  <li>Event sourcing provides complete audit trails</li>
  <li>CQRS optimizes read and write models separately</li>
  <li>Streaming platforms enable real-time processing</li>
  <li>Eventual consistency requires careful design</li>
</ol>

<hr />

<h3 id="sources">Sources</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">https://martinfowler.com/eaaDev/EventSourcing.html</code></li>
  <li><code class="language-plaintext highlighter-rouge">https://www.confluent.io/blog/event-streaming-patterns/</code></li>
  <li><code class="language-plaintext highlighter-rouge">https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs</code></li>
  <li><code class="language-plaintext highlighter-rouge">https://www.oreilly.com/library/view/software-architecture-patterns/9781491971437/</code>
```</li>
</ul>

<h3 id="anti-patterns">Anti-patterns</h3>

<ul>
  <li>Using events for synchronous request-response patterns</li>
  <li>Creating chatty event interfaces with too many small events</li>
  <li>Not handling event ordering when it matters</li>
  <li>Ignoring event schema evolution and versioning</li>
  <li>Not implementing proper error handling and retry logic</li>
</ul>

                    
                    <!-- Factor Navigation Footer -->
                    <div class="factor-footer-nav">
                        
                            
                                <a href="/12-factor-app-website/factor-16-auth" class="footer-nav-btn prev">
                                    <div class="nav-direction">Previous Factor</div>
                                    <div class="nav-title">Factor 16: Auth</div>
                                </a>
                            
                        
                        
                        
                            
                                <a href="/12-factor-app-website/factor-18-failure-isolation" class="footer-nav-btn next">
                                    <div class="nav-direction">Next Factor</div>
                                    <div class="nav-title">Factor 18: Failure Isolation</div>
                                </a>
                            
                        
                    </div>
                </article>
            </div>
        </div>
    </div>
</div>

<!-- Progress Indicator -->
<div class="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
</div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>The Modern 17-Factor App</h3>
                    <p>An evolution of the twelve-factor methodology for modern cloud-native applications</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/12-factor-app-website/">Home</a></li>
                        <li><a href="/12-factor-app-website/factor-01-codebase">Original 12 Factors</a></li>
                        <li><a href="/12-factor-app-website/factor-13-api-first">New 5 Factors</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="https://12factor.net" target="_blank">Original 12-Factor App</a></li>
                        <li><a href="https://github.com/ifeatu/12-factor-app-website" target="_blank">GitHub Repository</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 The Modern 17-Factor App. Built with Jekyll.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/12-factor-app-website/assets/js/main.js"></script>
</body>
</html>